# TODO: Get example without nesting
test = {'0': {'SIDs': [], 'graph': {"dcrgraph": {"@title": "Aflevering 3", "@dataTypesStatus": "hide", "@filterLevel": "-1", "@insightFilter": "false", "@zoomLevel": "0", "@formGroupStyle": "Normal", "@formLayoutStyle": "Horizontal", "@formShowPendingCount": "true", "@graphBG": "#f1f6fe", "@graphType": "0", "@exercise": "false", "@version": "1.1", "meta": {"graph": {"@id": "1987618", "@hash": "780FE9C6B5797EA050103B45136907EB", "@guid": "1B9E75F7-0EA3-477C-979C-662BB55D9F92", "@OwnerName": "Emil Vedel Thage", "@OwnerId": "174110", "@categoryId": "10366", "@categoryTitle": "Default"}, "revision": {"@id": "4625064", "@type": "medium", "@date": "2025-03-10T10:35:02.200"}, "organization": {"@id": "1024", "@name": "KU - Academic Alliance"}}, "specification": {"resources": {"events": {"event": [{"@id": "A5", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "200", "@yLoc": "220"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Teacher"}, "readRoles": {"readRole": ["Group 1", "Group 2"]}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "1", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A6", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "250", "@yLoc": "620"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Teacher"}, "readRoles": {"readRole": ["Group 1", "Group 2"]}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "2", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A7", "@type": "nesting", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "450", "@yLoc": "20"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": None}, "readRoles": {"readRole": None}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "3", "costs": "0", "eventData": None, "interfaces": None}, "event": [{"@id": "A16", "@type": "nesting", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "650", "@yLoc": "320"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": None}, "readRoles": {"readRole": None}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "11", "costs": "0", "eventData": None, "interfaces": None}, "event": [{"@id": "A9", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "680", "@yLoc": "370"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Teacher"}, "readRoles": {"readRole": ["Group 1", "Group 2"]}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "5", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A12", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "830", "@yLoc": "370"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Teacher"}, "readRoles": {"readRole": ["Group 1", "Group 2"]}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "6", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A13", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "980", "@yLoc": "370"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Teacher"}, "readRoles": {"readRole": ["Group 1", "Group 2"]}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "7", "costs": "0", "eventData": None, "interfaces": None}}]}, {"@id": "A17", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "480", "@yLoc": "370"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Teacher"}, "readRoles": {"readRole": ["Group 1", "Group 2"]}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "8", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A15", "@type": "nesting", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "650", "@yLoc": "70"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": None}, "readRoles": {"readRole": None}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "13", "costs": "0", "eventData": None, "interfaces": None}, "event": [{"@id": "A4", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "680", "@yLoc": "120"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Group 1"}, "readRoles": {"readRole": "Teacher"}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "0", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A4Copy", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "860", "@yLoc": "120"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Group 2"}, "readRoles": {"readRole": "Teacher"}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "4", "costs": "0", "eventData": None, "interfaces": None}}]}]}, {"@id": "A14", "@type": "nesting", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "750", "@yLoc": "620"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": None}, "readRoles": {"readRole": None}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "12", "costs": "0", "eventData": None, "interfaces": None}, "event": [{"@id": "A28", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "780", "@yLoc": "670"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Group 1"}, "readRoles": {"readRole": None}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "9", "costs": "0", "eventData": None, "interfaces": None}}, {"@id": "A29", "precondition": {"@message": ""}, "custom": {"visualization": {"location": {"@xLoc": "930", "@yLoc": "670"}, "colors": {"@bg": "#f9f7ed", "@textStroke": "#000000", "@stroke": "#cccccc"}}, "roles": {"role": "Group 2"}, "readRoles": {"readRole": None}, "groups": {"group": None}, "phases": {"phase": None}, "eventType": None, "eventScope": "private", "eventTypeData": None, "eventDescription": None, "purpose": None, "guide": None, "insight": {"@use": "false"}, "level": "1", "sequence": "10", "costs": "0", "eventData": None, "interfaces": None}}]}]}, "subProcesses": None, "distribution": None, "labels": {"label": [{"@id": "Open Assignment"}, {"@id": "Start Exam"}, {"@id": "Assignment"}, {"@id": "Close Assignments"}, {"@id": "Close Assignment"}, {"@id": "Close Assignment 1"}, {"@id": "Close Assignment 2"}, {"@id": "Close - No Hand-Ins"}, {"@id": "Hand-Ins"}, {"@id": "Hand-In"}, {"@id": "Hand-In"}, {"@id": "Exam Attendance"}, {"@id": "Attend Exam G1"}, {"@id": "Attend Exam G2"}]}, "labelMappings": {"labelMapping": [{"@eventId": "A5", "@labelId": "Open Assignment"}, {"@eventId": "A6", "@labelId": "Start Exam"}, {"@eventId": "A7", "@labelId": "Assignment"}, {"@eventId": "A16", "@labelId": "Close Assignments"}, {"@eventId": "A9", "@labelId": "Close Assignment"}, {"@eventId": "A12", "@labelId": "Close Assignment 1"}, {"@eventId": "A13", "@labelId": "Close Assignment 2"}, {"@eventId": "A17", "@labelId": "Close - No Hand-Ins"}, {"@eventId": "A15", "@labelId": "Hand-Ins"}, {"@eventId": "A4", "@labelId": "Hand-In"}, {"@eventId": "A4Copy", "@labelId": "Hand-In"}, {"@eventId": "A14", "@labelId": "Exam Attendance"}, {"@eventId": "A28", "@labelId": "Attend Exam G1"}, {"@eventId": "A29", "@labelId": "Attend Exam G2"}]}, "expressions": None, "variables": None, "variableAccesses": {"writeAccesses": None}, "custom": {"keywords": None, "roles": {"role": [{"@description": "d", "@specification": "df", "#text": "fg"}, {"@description": "", "@specification": "", "#text": "Not fg"}, {"@description": "", "@specification": "", "#text": "Teacher"}, {"@description": "", "@specification": "", "#text": "Group 1"}, {"@description": "", "@specification": "", "#text": "Group 2"}]}, "groups": {"group": {"@sequence": "4", "@description": "sd", "#text": "sd"}}, "phases": None, "eventTypes": None, "eventParameters": None, "graphDetails": "DCR Process", "graphDocumentation": None, "graphLanguage": "en-US", "graphDomain": "process", "graphFilters": {"filteredGroups": None, "filteredRoles": None, "filteredPhases": None}, "hightlighterMarkup": {"@id": "HLM"}, "highlighterMarkup": {"highlightLayers": {"highlightLayer": {"@default": "true", "@name": "description", "#text": "DCR Process"}}, "highlights": None}}}, "constraints": {"conditions": None, "responses": {"response": [{"@sourceId": "A5", "@targetId": "A7", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A6", "@targetId": "A14", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A16", "@targetId": "A5", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A17", "@targetId": "A5", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}]}, "coresponses": None, "excludes": {"exclude": [{"@sourceId": "A5", "@targetId": "A6", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A6", "@targetId": "A5", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A17", "@targetId": "A14", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A12", "@targetId": "A28", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A13", "@targetId": "A29", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A29", "@targetId": "A29", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A28", "@targetId": "A28", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A12", "@targetId": "A13", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A13", "@targetId": "A12", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A17", "@targetId": "A16", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A12", "@targetId": "A9", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A13", "@targetId": "A9", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A17", "@targetId": "A17", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A6", "@targetId": "A7", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A6", "@targetId": "A6", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A15", "@targetId": "A17", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A4", "@targetId": "A13", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A4Copy", "@targetId": "A12", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A12", "@targetId": "A4Copy", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A13", "@targetId": "A4", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A17", "@targetId": "A15", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}]}, "includes": {"include": [{"@sourceId": "A17", "@targetId": "A6", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A16", "@targetId": "A6", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A5", "@targetId": "A17", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A9", "@targetId": "A16", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}]}, "milestones": {"milestone": [{"@sourceId": "A5", "@targetId": "A7", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A6", "@targetId": "A14", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A7", "@targetId": "A14", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A4Copy", "@targetId": "A13", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A4", "@targetId": "A12", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}, {"@sourceId": "A15", "@targetId": "A9", "@filterLevel": "1", "@description": "", "@time": "", "@groups": ""}]}, "updates": None, "spawns": None, "templateSpawns": None}}, "runtime": {"custom": {"globalMarking": None}, "marking": {"globalStore": None, "executed": None, "included": {"event": [{"@id": "A5"}, {"@id": "A6"}, {"@id": "A16"}, {"@id": "A9"}, {"@id": "A12"}, {"@id": "A13"}, {"@id": "A17"}, {"@id": "A15"}, {"@id": "A4"}, {"@id": "A4Copy"}, {"@id": "A14"}, {"@id": "A28"}, {"@id": "A29"}]}, "pendingResponses": {"event": [{"@id": "A5"}, {"@id": "A6"}]}}}}}}}

import xmltodict, json
from flask import Flask, request
import xml.etree.ElementTree as ET
from pm4py.objects.dcr.hierarchical.obj import HierarchicalDcrGraph
from simulatorInit import createDCRgraph, ExecuteEventOnGraph
app = Flask(__name__)
graphIDs = {}
simIDs = {}
access = {}
reavailableGid = []
reavailableSid = []
graphIDs.update(test)

def replaceAllInstances(input, old, new):
    if isinstance(input, dict):
        return {k: replaceAllInstances(v, old, new) for k, v in input.items()}
    elif isinstance(input, list):
        return [replaceAllInstances(elem, old, new) for elem in input]
    elif input == old:
        return new
    return input

def findGraph(GID):
    try:
        return graphIDs[GID]
    except:
        return None

def removeGraph(GID):
    graph = graphIDs.pop(GID)
    SIDs = graph['SIDs']
    for s in SIDs:
        simIDs.pop(s)
        
    for key, vals in access.items():
        if GID in vals:
            vals.remove(GID)
            access[key] = vals
            break
        
    reavailableGid.append(GID)
    return True

def findSim(SID):
    try:
        return simIDs[SID]
    except:
        return None

def removeSim(GID, SID):
    simIDs.pop(SID)
    graph = graphIDs[GID] 
    graph['SIDs'].remove(SID)
    graphIDs[GID]['SIDs'] = graph['SIDs']
    reavailableSid.append(SID)

def findAccess(key):
    try:
        return access[key]
    except:
        return None

# Access check for graph data
def checkAccessGraph(header, GID):
    key = header['Authorization']
    access = findAccess(key)
    if access is None:
        return False
    if GID in access:
        return True
    
    return False

# Access check for simulators
def checkAccessSim(header, GID, SID):
    if checkAccessGraph(header, GID):
        graph = findGraph(GID)
        if SID in graph['SIDs']:
            return True
    return False

def checkLoggedIn(header):
    if header['Authorization'] == "Basic Og==" or not ('Basic' in header['Authorization']):
        return False
    return True

def assignGid():
    if reavailableGid:
        return reavailableGid.pop()
    else:
        return str(len(graphIDs))

def assignSid():
    if reavailableSid:
        return reavailableSid.pop()
    else:
        return str(len(simIDs))

@app.post('/api/utility/xml2dcr')
def loadXML():
    # TODO: Error handling
    xml = request.data
    header = request.headers
    if not checkLoggedIn(header):
        return 'Not Logged In/ Invalid Authorization Type'

    dict = xmltodict.parse(xml)
    dict = replaceAllInstances(dict, 'null', None) # For easier python handling
    gid = assignGid()
    jsn = {gid: {'SIDs': [], 'graph': dict}}
    graphIDs.update(jsn)

    key = header['Authorization']

    if (gidList := findAccess(key)) is None:
        jsn = {f'{key}': [gid]}
        access.update(jsn)
    else:
        gidList.append(gid)
        access[f'{key}'] = gidList
    print(access)

    return gid

@app.get('/api/graphs/<string:GID>')
def getGraph(GID):
    if not checkAccessGraph(request.headers, GID):
        return 'Access Denied'
    
    graph = findGraph(GID)
    if graph is not None:
        return graph
    return "Unknown GID"

@app.delete('/api/graphs/<string:GID>')
def deleteGraph(GID):
    if not checkAccessGraph(request.headers, GID):
        return 'Access Denied'
    
    removeGraph(GID)
    return "Sucess"

# Creates a DCRGraph object of GID
@app.post('/api/graphs/<string:GID>/DCRsimulator')
def SimulateInit(GID):
    if not checkAccessGraph(request.headers, GID):
        return 'Access Denied'
    
    graph = findGraph(GID)
    if graph:
            dcr = createDCRgraph(graph)
            sid = assignSid()
            graph['SIDs'].append(sid)
            graphIDs[GID] = graph
            jsn = {sid: dcr}
            simIDs.update(jsn)
            return {sid: dcr.__repr__()} #TODO: Return executable events
    return "Unknown GID"

@app.get('/api/graphs/<string:GID>/DCRsimulator/<string:SID>')
def getSimulation(GID, SID):
    if not checkAccessSim(request.headers, GID, SID):
        return 'Access Denied'
    
    sim = findSim(SID)
    if sim:
        return {SID: sim.__repr__()}
    return "Unknown SID"

@app.delete('/api/graphs/<string:GID>/DCRsimulator/<string:SID>')
def deleteSim(GID, SID):
    if not checkAccessSim(request.headers, GID, SID):
        return 'Access Denied'
    
    removeSim(GID, SID)
    return "Sucess"

@app.post('/api/graphs/<string:GID>/DCRsimulator/<string:SID>/executeEvent/<string:event>')
def executeEvent(GID, SID, event):
    if not checkAccessSim(request.headers, GID, SID):
        return 'Access Denied'
    
    sim = findSim(SID)
    if sim:
        res = ExecuteEventOnGraph(sim, event)
        if not isinstance(res, str):
            res = {SID: res.__repr__()}
        return res
    return 'Unknown SID'